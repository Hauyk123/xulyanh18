<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đề tài 3: Phân đoạn ảnh Thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .card {
        background-color: white;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.2s;
        cursor: pointer;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -5px rgb(102 126 234 / 0.4);
      }
      .btn-download {
        background-color: #10b981; /* Xanh lá */
        color: white;
      }
      .btn-download:hover {
        background-color: #059669;
      }
      .btn-csv {
        background-color: #8b5cf6; /* Tím */
        color: white;
      }
      .btn-csv:hover {
        background-color: #7c3aed;
      }

      .flash-message-container {
        /* Đảm bảo chiều cao cố định để giữ vị trí cho nút "Xử lý ảnh" */
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.75rem;
      }

      .flash-message {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Class để ẩn thông báo mà không làm thay đổi chiều cao của container */
      .hidden-flash {
        display: none !important;
      }
    </style>
  </head>
  <body class="p-6">
    <div class="max-w-7xl mx-auto">
      <header class="text-center mb-6">
        <h1 class="text-2xl font-bold text-white">Phân đoạn ảnh Thông minh</h1>
      </header>

      <div class="card p-6 mb-6">
        <form method="POST" enctype="multipart/form-data">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <div class="flex flex-col md:col-span-6">
              <label class="block text-sm font-semibold text-gray-800 mb-2">
                <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                Tải ảnh lên
              </label>
              <label
                for="file-upload"
                id="drop-zone"
                class="flex flex-col items-center justify-center w-full flex-1 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors"
              >
                <div id="drop-zone-content" class="text-center px-2">
                  <i
                    data-lucide="image-plus"
                    class="w-10 h-10 mx-auto mb-3 text-gray-400"
                  ></i>
                  <p class="text-sm text-gray-800">
                    <span class="font-semibold">Chọn file</span>
                  </p>
                  <p class="text-sm text-gray-500 mt-1">PNG, JPG, BMP</p>
                </div>

                <input
                  id="file-upload"
                  name="file"
                  type="file"
                  required
                  class="hidden"
                />
              </label>
            </div>

            <div class="flex flex-col md:col-span-3">
              <label class="block text-sm font-semibold text-gray-800 mb-2">
                <i data-lucide="sliders" class="w-4 h-4 inline mr-1"></i>
                Thuật toán
              </label>
              <div
                class="space-y-3 flex-1 flex flex-col justify-center bg-gray-50 rounded-lg p-4"
              >
                <div class="flex items-center">
                  <input
                    id="check-kmeans"
                    name="algorithms"
                    value="kmeans"
                    type="checkbox"
                    checked
                    class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                  />
                  <label
                    for="check-kmeans"
                    class="ml-2 text-sm text-gray-800 font-medium"
                    >K-Means</label
                  >
                </div>
                <div class="pl-6">
                  <label for="k-value" class="text-xs text-gray-600"
                    >Số cụm (K):</label
                  >
                  <input
                    type="number"
                    name="k_value"
                    id="k-value"
                    value="3"
                    min="2"
                    max="10"
                    class="ml-2 w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                </div>
                <div class="flex items-center">
                  <input
                    id="check-otsu"
                    name="algorithms"
                    value="otsu"
                    type="checkbox"
                    class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                  />
                  <label
                    for="check-otsu"
                    class="ml-2 text-sm text-gray-800 font-medium"
                    >Otsu</label
                  >
                </div>
              </div>
            </div>

            <div class="flex flex-col md:col-span-3">
              <label
                class="block text-sm font-semibold text-gray-800 mb-2 invisible"
              >
                Placeholder
              </label>

              <div class="flash-message-container">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %} {% for category, message in messages %} {% if
                category == 'error' %}
                <div
                  id="flash-message-box"
                  class="flash-message bg-red-100 border-l-4 border-red-500 text-red-800 p-2 rounded text-xs w-full"
                >
                  <p class="font-bold flex items-center gap-1">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i>
                    Lỗi
                  </p>
                  <p class="mt-1">{{ message }}</p>
                </div>
                {% elif category == 'warning' %}
                <div
                  id="flash-message-box"
                  class="flash-message bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-2 rounded text-xs w-full"
                >
                  <p class="font-bold flex items-center gap-1">
                    <i data-lucide="alert-triangle" class="w-3 h-3"></i>
                    Cảnh báo
                  </p>
                  <p class="mt-1">{{ message }}</p>
                </div>
                {% else %}
                <div
                  id="flash-message-box"
                  class="flash-message bg-green-100 border-l-4 border-green-500 text-green-800 p-2 rounded text-xs w-full"
                >
                  <p class="font-bold flex items-center gap-1">
                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                    Thành công
                  </p>
                  <p class="mt-1">{{ message }}</p>
                </div>
                {% endif %} {% endfor %} {% endif %} {% endwith %}
              </div>

              <button type="submit" class="btn btn-primary w-full h-12">
                <i data-lucide="sparkles" class="w-4 h-4"></i>
                Xử lý ảnh
              </button>
            </div>
          </div>
        </form>
      </div>

      <div id="result-section-container" class="mt-6">
        <h2 class="text-xl font-bold text-white mb-4">Kết quả Xử lý Ảnh</h2>

        <div class="card p-6 h-auto min-h-96">
          {% if results %} {% set num_algorithms = (results.kmeans is not none)
          + (results.otsu is not none) %} {% set num_columns = 1 +
          num_algorithms %} {% set grid_cols_class = 'md:grid-cols-' ~
          num_columns %}

          <div class="grid grid-cols-1 {{ grid_cols_class }} gap-6">
            <div class="overflow-hidden rounded-lg shadow-md bg-white">
              <div class="bg-gradient-to-r from-gray-600 to-gray-700 px-4 py-3">
                <h3 class="font-semibold text-white text-sm">Ảnh gốc</h3>
              </div>
              <div
                class="p-4 flex items-center justify-center bg-gray-50"
                style="height: 280px"
              >
                <img
                  src="{{ results.original }}"
                  alt="Ảnh gốc"
                  class="max-w-full max-h-full object-contain rounded"
                />
              </div>
              <div class="p-3 border-t border-gray-200">
                <a
                  href="{{ results.original }}"
                  download
                  class="btn btn-download w-full"
                >
                  <i data-lucide="download" class="w-4 h-4"></i>
                  Tải về
                </a>
              </div>
            </div>

            {% if results.kmeans %}
            <div class="overflow-hidden rounded-lg shadow-md bg-white">
              <div
                class="bg-gradient-to-r from-blue-600 to-purple-600 px-4 py-3"
              >
                <h3 class="font-semibold text-white text-sm">
                  K-Means (K={{ results.k_value }})
                </h3>
              </div>
              <div
                class="p-4 flex items-center justify-center bg-gray-50"
                style="height: 280px"
              >
                <img
                  src="{{ results.kmeans.img_path }}"
                  alt="K-Means"
                  class="max-w-full max-h-full object-contain rounded"
                />
              </div>
              <div class="p-3 border-t border-gray-200">
                <a
                  href="{{ results.kmeans.img_path }}"
                  download
                  class="btn btn-download w-full"
                >
                  <i data-lucide="download" class="w-4 h-4"></i>
                  Tải PNG
                </a>
              </div>
            </div>
            {% endif %} {% if results.otsu %}
            <div class="overflow-hidden rounded-lg shadow-md bg-white">
              <div
                class="bg-gradient-to-r from-green-600 to-emerald-600 px-4 py-3"
              >
                <h3 class="font-semibold text-white text-sm">Otsu</h3>
              </div>
              <div
                class="p-4 flex items-center justify-center bg-gray-50"
                style="height: 280px"
              >
                <img
                  src="{{ results.otsu.img_path }}"
                  alt="Otsu"
                  class="max-w-full max-h-full object-contain rounded"
                />
              </div>
              <div class="p-3 border-t border-gray-200 space-x-2 flex">
                <a
                  href="{{ results.otsu.img_path }}"
                  download
                  class="btn btn-download flex-1"
                >
                  <i data-lucide="download" class="w-4 h-4"></i>
                  Tải PNG
                </a>
                <a
                  href="/download/results/{{ results.otsu.csv_file }}"
                  class="btn btn-csv flex-1"
                >
                  <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                  Tải CSV
                </a>
              </div>
            </div>
            {% endif %}
          </div>
          {% else %}
          <div
            class="flex items-center justify-center h-full text-gray-400"
            style="min-height: 20rem"
          >
            <div class="text-center">
              <i data-lucide="sparkles" class="w-16 h-16 mx-auto mb-2"></i>
              <p class="text-lg font-semibold">
                Kết quả sẽ hiển thị ở đây sau khi xử lý.
              </p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      lucide.createIcons();

      const fileUpload = document.getElementById("file-upload");
      const dropZoneContent = document.getElementById("drop-zone-content");
      // Lấy phần tử chứa thông báo flash
      const flashMessageBox = document.getElementById("flash-message-box");

      if (fileUpload) {
        fileUpload.addEventListener("change", (event) => {
          // 1. Ẩn thông báo flash (nếu có)
          if (flashMessageBox) {
            // Thêm class 'hidden-flash' để ẩn thông báo
            flashMessageBox.classList.add("hidden-flash");
          }

          // 2. Hiển thị preview ảnh mới
          const files = event.target.files;
          if (files && files[0]) {
            displayPreview(files[0]);
          }
        });
      }

      function displayPreview(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          dropZoneContent.innerHTML = `<img src="${e.target.result}" alt="Preview" class="max-h-32 rounded object-contain">`;
        };
        reader.readAsDataURL(file);
      }
    </script>
  </body>
</html>
